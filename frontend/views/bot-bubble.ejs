<div class="bubble left-bubble">
    <div class="bubble-direction"></div>

    <div class="text">
        <% 
            const formatString = (template, name) => template.replace(/\[placeholder_name\]/g, `\<b>${name}\</b>`);

            
            const averageDistance = (arr, maxProbability) => {
                let differences = arr.filter(x => x !== maxProbability).map(x => maxProbability - x);
                let averageDifference = differences.reduce((a, b) => a + b, 0) / differences.length;

                return averageDifference;
            }

            const randomPhrase = (arr, probability, name) => {
                let certainty = "";

                let avgDistance = averageDistance(arr, probability);

                if(avgDistance < 0.25) {
                    certainty = "Doubtful";
                } else if(avgDistance < 0.5) {
                    certainty = "Probable";
                } else {
                    certainty = "Certain";
                }

                let phrases = guessPhrases[certainty];
                let randomIndex = Math.floor(Math.random() * phrases.length);
                
                return formatString(phrases[randomIndex], name);
            };

            let maxIndex = single
                .reduce((iMax, x, i, arr) => x > arr[iMax] ? i : iMax, 0);
            
            let guessPhrases = {
                "Doubtful": [
                    `Non sono sicuro, ma credo che tu sia [placeholder_name] ğŸ¤”`,
                    `Sono indeciso ğŸ˜•, ma credo che tu sia [placeholder_name]`,
                    `Non sono molto sicuro, ma penso che tu sia [placeholder_name]`,
                    `Hmmm...ğŸ¤” Potresti essere [placeholder_name]?`,
                    `Tiro il D20!ğŸ² Ed Ã¨... 1 naturale...ğŸ˜” Sei [placeholder_name]?`,
                    `ğŸ¶ğŸ‰Chi sei? [placeholder_name] non lo so(?)ğŸ¶`,
                    `ğŸš€ğŸ¤–[placeholder_name], io sono tuo padre! Aspe, ma sei tu?`,
                    `Ho gli occhiali sporchi... ğŸ¥¸ sei [placeholder_name]?`,
                ],

                "Probable": [
                    `Sei [placeholder_name], o mi sbaglio? ğŸ¤¨`,
                    `Sei per caso [placeholder_name]?`,
                    `Hai le vibes da [placeholder_name]ğŸ˜‰`,
                    `[placeholder_name]? Sei tu?`,
                    `Oh, ma certo, il veleno! ğŸ˜¯\
                    Il veleno per [placeholder_name]! ğŸ˜\<br>\
                    Il veleno scelto appositamente per uccidere [placeholder_name]! ğŸ˜ˆ\<br>\
                    [placeholder_name] e il suo veleno!.... Quel veleno? ğŸ˜Œ`,
                    `Aspetta ma sei tu, [placeholder_name] di Rivia?ğŸ˜¨`,
                    `Ma tu sei il grande [placeholder_name], figlio di Kmer della tribÃ¹ di Instar?`,
                    `Hello there, General [placeholder_name].ğŸ‘¾ğŸš€`,
                    `ğŸš€La risposta Ã¨ 42- cioÃ¨ [placeholder_name]!ğŸ“•`,
                    `Hey Link! Ehm, volevo dire [placeholder_name]!ğŸ§ğŸ›¡ï¸`
                ],

                "Certain": [
                    `Sei [placeholder_name]!ğŸ˜`,
                    `Non c'Ã¨ dubbio, sei [placeholder_name]!`,
                    `Sei sicuramente [placeholder_name]ğŸ˜Š`,
                    `Sono sicuro che tu sia [placeholder_name]`,
                    `Tu sei [placeholder_name], o il mio nome Ã¨ Ugo, e non lo Ã¨!`,
                    `It's-a you [placeholder_name]!`,
                    `Vai [placeholder_name],ğŸ”´âšªï¸ scelgo te!`,
                    `Say my nameğŸ˜! [placeholder_name]! You're goddamn right.`
                ]
            };
        %> 

        <p><%- randomPhrase(single, single[maxIndex], mappedUsers[maxIndex])  %></p>

        <b>Predizione su messaggio singolo:</b> <br>
        

        <table>
            <tbody>
                <% single.forEach((element, index) => { %>
                  <tr>
                    <td><%= mappedUsers[index] %>:</td>

                    <td>
                        <meter class="<%= index === maxIndex ? 'highestPrediction' : '' %>" value="<%= element %>" min="0" max="1"></meter>
                    </td>

                    <td><%= (element * 100).toFixed(2) %>%</td>
                  </tr>
                <% }) %>
            </tbody>
        </table>
        
        <% if(typeof responseText !== "undefined") { %>
            <%= responseText %>
        <% } %>
    </div>
</div>